# 🎯 ВИЗУАЛЬНАЯ СХЕМА РАБОТЫ ТОРГОВОГО БОТА

## 📊 АРХИТЕКТУРНАЯ ДИАГРАММА

```
┌─────────────────────────────────────────────────────────────────┐
│                        ТОРГОВЫЙ БОТ                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐     │
│  │ bot_runner  │───▶│ config.yaml  │───▶│ UniversalTrader │     │
│  │   .py       │    │   files      │    │                 │     │
│  └─────────────┘    └──────────────┘    └─────────────────┘     │
│                                                   │               │
│  ┌─────────────────────────────────────────────────┼─────────────┐ │
│  │                КОМПОНЕНТЫ СИСТЕМЫ               │             │ │
│  │                                                 ▼             │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐   │ │
│  │ │SolanaClient │ │   Wallet    │ │  PriorityFeeManager     │   │ │
│  │ │             │ │             │ │                         │   │ │
│  │ │• connect()  │ │• sign_tx()  │ │• calculate_dynamic()    │   │ │
│  │ │• send_tx()  │ │• get_key()  │ │• calculate_fixed()      │   │ │
│  │ └─────────────┘ └─────────────┘ └─────────────────────────┘   │ │
│  │                                                               │ │
│  │ ┌─────────────────────────────────────────────────────────┐   │ │
│  │ │              ПЛАТФОРМЫ (pump.fun/letsbonk)              │   │ │
│  │ │                                                         │   │ │
│  │ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐     │   │ │
│  │ │ │AddressProvider│ │InstructionBuilder│ │EventParser   │     │   │ │
│  │ │ │             │ │             │ │                 │     │   │ │
│  │ │ │• get_pda()  │ │• buy_ix()   │ │• parse_create() │     │   │ │
│  │ │ │• get_ata()  │ │• sell_ix()  │ │• parse_trade()  │     │   │ │
│  │ │ └─────────────┘ └─────────────┘ └─────────────────┘     │   │ │
│  │ └─────────────────────────────────────────────────────────┘   │ │
│  │                                                               │ │
│  │ ┌─────────────────────────────────────────────────────────┐   │ │
│  │ │                    МОНИТОРИНГ                           │   │ │
│  │ │                                                         │   │ │
│  │ │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐     │   │ │
│  │ │ │ Geyser  │ │  Logs   │ │ Blocks  │ │ PumpPortal  │     │   │ │
│  │ │ │Listener │ │Listener │ │Listener │ │  Listener   │     │   │ │
│  │ │ │ (100ms) │ │ (200ms) │ │ (500ms) │ │   (300ms)   │     │   │ │
│  │ │ └─────────┘ └─────────┘ └─────────┘ └─────────────┘     │   │ │
│  │ └─────────────────────────────────────────────────────────┘   │ │
│  │                                                               │ │
│  │ ┌─────────────────────────────────────────────────────────┐   │ │
│  │ │                   ТОРГОВЛЯ                              │   │ │
│  │ │                                                         │   │ │
│  │ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐     │   │ │
│  │ │ │   Buyer     │ │   Seller    │ │  TpSlManager    │     │   │ │
│  │ │ │             │ │             │ │                 │     │   │ │
│  │ │ │• buy_token()│ │• sell_token()│ │• monitor_price()│     │   │ │
│  │ │ │• retry()    │ │• retry()    │ │• check_tp_sl()  │     │   │ │
│  │ │ └─────────────┘ └─────────────┘ └─────────────────┘     │   │ │
│  │ └─────────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 ПОТОК ВЫПОЛНЕНИЯ (ДЕТАЛЬНАЯ СХЕМА)

### ЭТАП 1: ИНИЦИАЛИЗАЦИЯ

```
START
  │
  ▼
┌─────────────────┐
│ Загрузка YAML  │
│ конфигурации    │
└─────────────────┘
  │
  ▼
┌─────────────────┐     ❌ Ошибка
│ Валидация       │────────────┐
│ платформы       │            │
└─────────────────┘            │
  │ ✅ OK                      │
  ▼                            │
┌─────────────────┐            │
│ Валидация       │────────────┤
│ listener'а      │            │
└─────────────────┘            │
  │ ✅ OK                      │
  ▼                            │
┌─────────────────┐            │
│ Создание        │            │
│ UniversalTrader │            │
└─────────────────┘            │
  │                            │
  ▼                            │
┌─────────────────┐            │
│ Инициализация   │            │
│ компонентов     │            │
└─────────────────┘            │
  │                            │
  ▼                            │
┌─────────────────┐            │
│ Запуск          │            │
│ мониторинга     │            │
└─────────────────┘            │
  │                            │
  ▼                            │
┌─────────────────┐            │
│ Ожидание новых  │◀───────────┘
│ токенов         │ ВЫХОД
└─────────────────┘
```

### ЭТАП 2: ОБНАРУЖЕНИЕ ТОКЕНА

```
┌─────────────────┐
│ Blockchain      │
│ Events          │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Listener        │
│ получает данные │
└─────────────────┘
  │
  ▼
┌─────────────────┐     ❌ Не pump.fun
│ Фильтрация      │────────────────┐
│ транзакций      │                │
└─────────────────┘                │
  │ ✅ pump.fun                    │
  ▼                                │
┌─────────────────┐                │
│ Парсинг данных  │                │
│ токена          │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐     ❌ Невалидный │
│ Валидация       │────────────────┤
│ токена          │                │
└─────────────────┘                │
  │ ✅ Валидный                    │
  ▼                                │
┌─────────────────┐                │
│ Создание        │                │
│ TokenInfo       │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ Вызов callback  │                │
│ handle_new_token│                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ ТОРГОВЫЙ ЦИКЛ   │                │
└─────────────────┘                │
                   │                │
                   ▼                │
                ┌─────────────────┐ │
                │ Продолжить      │◀┘
                │ мониторинг      │
                └─────────────────┘
```

### ЭТАП 3: ТОРГОВЫЙ ЦИКЛ

```
┌─────────────────┐
│ TokenInfo       │
│ получен         │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Создание        │
│ Position        │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ ПОКУПКА         │
│                 │
│ 1. Получить PDA │
│ 2. Создать IX   │
│ 3. Добавить fee │
│ 4. Подписать TX │
│ 5. Отправить    │
│ 6. Подтвердить  │
└─────────────────┘
  │
  ▼
┌─────────────────┐     ❌ Неудача
│ Результат       │────────────────┐
│ покупки         │                │
└─────────────────┘                │
  │ ✅ Успех                       │
  ▼                                │
┌─────────────────┐                │
│ МОНИТОРИНГ      │                │
│ ПОЗИЦИИ         │                │
│                 │                │
│ Стратегии:      │                │
│ • Time-based    │                │
│ • TP/SL         │                │
│ • Extreme Fast  │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ Сигнал на       │                │
│ продажу         │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ ПРОДАЖА         │                │
│                 │                │
│ 1. Получить     │                │
│    баланс       │                │
│ 2. Создать IX   │                │
│ 3. Отправить TX │                │
│ 4. Подтвердить  │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ CLEANUP         │                │
│                 │                │
│ 1. Закрыть ATA  │                │
│ 2. Вернуть SOL  │                │
│ 3. Логирование  │                │
└─────────────────┘                │
  │                                │
  ▼                                │
┌─────────────────┐                │
│ Ожидание нового │◀───────────────┤
│ токена          │                │
└─────────────────┘                │
                                   │
                ┌─────────────────┐ │
                │ CLEANUP ПОСЛЕ   │◀┘
                │ НЕУДАЧИ         │
                │                 │
                │ 1. Закрыть      │
                │    неисп. ATA   │
                │ 2. Логирование  │
                └─────────────────┘
```

---

## ⚡ ДЕТАЛЬНАЯ СХЕМА ПОКУПКИ

```
┌─────────────────┐
│ execute_buy()   │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 1. Получение    │
│    адресов      │
│                 │
│ • mint          │
│ • bonding_curve │
│ • user_ata      │
│ • metadata      │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 2. Расчет       │
│    priority fee │
│                 │
│ • dynamic/fixed │
│ • + extra %     │
│ • ≤ hard_cap    │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 3. Создание     │
│    инструкции   │
│                 │
│ • program_id    │
│ • accounts[]    │
│ • data (amount) │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 4. Создание TX  │
│                 │
│ • add IX        │
│ • add fee IX    │
│ • set blockhash │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 5. Подпись TX   │
│                 │
│ • wallet.sign() │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ 6. Отправка     │
│    с retry      │
│                 │
│ for i in range  │
│   (max_retries):│
│   try: send()   │
│   except: wait  │
└─────────────────┘
  │
  ▼
┌─────────────────┐     ❌ Неудача
│ 7. Подтверждение│────────────────┐
│                 │                │
│ • confirm_tx()  │                │
│ • check status  │                │
└─────────────────┘                │
  │ ✅ Успех                       │
  ▼                                │
┌─────────────────┐                │
│ TradeResult     │                │
│ (success=True)  │                │
└─────────────────┘                │
                                   │
                ┌─────────────────┐ │
                │ TradeResult     │◀┘
                │ (success=False) │
                └─────────────────┘
```

---

## 📊 СХЕМА МОНИТОРИНГА ПОЗИЦИИ

```
┌─────────────────┐
│ Position        │
│ создана         │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Выбор стратегии │
│ exit_strategy   │
└─────────────────┘
  │
  ├─────────────────────────────────────────┐
  │                                         │
  ▼                                         ▼
┌─────────────────┐                 ┌─────────────────┐
│ TIME-BASED      │                 │ TP/SL STRATEGY  │
│                 │                 │                 │
│ await sleep(    │                 │ while True:     │
│   max_hold_time)│                 │   price = get() │
│                 │                 │   profit = calc │
│ return          │                 │   if profit >=  │
│ SellSignal(     │                 │     tp: sell    │
│   "time_limit") │                 │   if profit <=  │
└─────────────────┘                 │     sl: sell    │
  │                                 │   await sleep() │
  │                                 └─────────────────┘
  │                                         │
  │         ┌─────────────────┐             │
  │         │ EXTREME FAST    │             │
  │         │                 │             │
  │         │ await sleep(    │             │
  │         │   wait_after_   │             │
  │         │   buy)          │             │
  │         │                 │             │
  │         │ return          │             │
  │         │ SellSignal(     │             │
  │         │   "extreme")    │             │
  │         └─────────────────┘             │
  │                   │                     │
  └───────────────────┼─────────────────────┘
                      │
                      ▼
              ┌─────────────────┐
              │ SellSignal      │
              │ получен         │
              └─────────────────┘
                      │
                      ▼
              ┌─────────────────┐
              │ execute_sell()  │
              └─────────────────┘
```

---

## 🧹 СХЕМА CLEANUP СИСТЕМЫ

```
┌─────────────────┐
│ Торговля        │
│ завершена       │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Определение     │
│ режима cleanup  │
└─────────────────┘
  │
  ├─────────────────────────────────────────┐
  │                                         │
  ▼                                         ▼
┌─────────────────┐                 ┌─────────────────┐
│ ПОСЛЕ УСПЕШНОЙ  │                 │ ПОСЛЕ НЕУДАЧИ   │
│ ПРОДАЖИ         │                 │                 │
│                 │                 │ 1. Найти        │
│ 1. Проверить    │                 │    созданные    │
│    баланс ATA   │                 │    аккаунты     │
│ 2. Если = 0:    │                 │ 2. Закрыть      │
│    закрыть ATA  │                 │    неисп. ATA   │
│ 3. Вернуть SOL  │                 │ 3. Вернуть SOL  │
│    на основной  │                 │ 4. Логировать   │
└─────────────────┘                 └─────────────────┘
  │                                         │
  │         ┌─────────────────┐             │
  │         │ ПРИНУДИТЕЛЬНОЕ  │             │
  │         │ ЗАКРЫТИЕ        │             │
  │         │                 │             │
  │         │ 1. Сжечь        │             │
  │         │    остатки      │             │
  │         │    токенов      │             │
  │         │ 2. Закрыть ATA  │             │
  │         │ 3. Вернуть SOL  │             │
  │         └─────────────────┘             │
  │                   │                     │
  └───────────────────┼─────────────────────┘
                      │
                      ▼
              ┌─────────────────┐
              │ Cleanup         │
              │ завершен        │
              └─────────────────┘
                      │
                      ▼
              ┌─────────────────┐
              │ Ожидание нового │
              │ токена          │
              └─────────────────┘
```

---

## 🔧 СХЕМА PRIORITY FEE УПРАВЛЕНИЯ

```
┌─────────────────┐
│ Нужна комиссия  │
│ для TX          │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│ Проверка        │
│ настроек        │
└─────────────────┘
  │
  ├─────────────────────────────────────────┐
  │                                         │
  ▼                                         ▼
┌─────────────────┐                 ┌─────────────────┐
│ ДИНАМИЧЕСКАЯ    │                 │ ФИКСИРОВАННАЯ   │
│ КОМИССИЯ        │                 │ КОМИССИЯ        │
│                 │                 │                 │
│ 1. Получить     │                 │ return          │
│    recent_fees  │                 │ fixed_amount    │
│ 2. Рассчитать   │                 │                 │
│    75 percentile│                 │                 │
│ 3. * (1+extra%) │                 │                 │
│ 4. min(fee,cap) │                 │                 │
└─────────────────┘                 └─────────────────┘
  │                                         │
  └─────────────────┬───────────────────────┘
                    │
                    ▼
            ┌─────────────────┐
            │ Финальная       │
            │ комиссия        │
            └─────────────────┘
                    │
                    ▼
            ┌─────────────────┐
            │ Добавление к TX │
            │ как инструкция  │
            └─────────────────┘
```

---

## 📈 ВРЕМЕННАЯ ДИАГРАММА

```
Время →  0ms    100ms   1s     2s     10s    20s    30s    ...

Listener │████│████│████│████│████│████│████│████│
         │ Мониторинг блоков (непрерывно)        │

Token    │    │    │ ⚡ │    │    │    │    │    │
Found    │    │    │Найден│    │    │    │    │    │

Buy      │    │    │    │████│    │    │    │    │
Process  │    │    │    │1-3s│    │    │    │    │

Position │    │    │    │    │████│████│████│████│
Monitor  │    │    │    │    │ Каждые 10 сек    │

Sell     │    │    │    │    │    │    │████│    │
Process  │    │    │    │    │    │    │1-3s│    │

Cleanup  │    │    │    │    │    │    │    │████│
         │    │    │    │    │    │    │    │5-10s│

Legend:
████ - Активный процесс
⚡   - Событие
│    - Ожидание
```

---

## 🎯 КРИТИЧЕСКИЕ ТОЧКИ ПРОИЗВОДИТЕЛЬНОСТИ

### 1. **Скорость обнаружения токенов**
```
Geyser:     ~100ms  ⚡ (самый быстрый)
Logs:       ~200ms  
Blocks:     ~500ms  
PumpPortal: ~300ms  
```

### 2. **Время выполнения торговли**
```
Покупка:    1-3 секунды
Продажа:    1-3 секунды
Cleanup:    5-10 секунд
```

### 3. **Retry интервалы**
```
Network:    1-2 секунды
TX retry:   1s → 2s → 4s → 8s (экспоненциально)
Price:      10 секунд (настраивается)
```

Эта визуальная схема показывает все критические процессы, временные интервалы и точки принятия решений в торговом боте.
